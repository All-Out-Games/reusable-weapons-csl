Bouncing_Projectile :: class : Component {
    damage: float;
    lifetime: float;
    direction: v2;
    owner_id: u64;
    speed: float;
    max_lifetime: float;
    max_bounces: s64;
    bounce_count: s64;
    bounce_target_radius: float;
    last_hit_id: u64;
    damage_scale_per_bounce: float;
    grow_per_bounce: bool;

    ao_update :: method(dt: float) {
        lifetime += dt;
        if max_lifetime <= 0 {
            max_lifetime = 5.0;
        }
        if lifetime > max_lifetime {
            entity->destroy();
            return;
        }

        move := v2{direction.x * speed * dt, direction.y * speed * dt};
        entity->add_local_position(move);

        if Game.is_server() {
            pos := entity.world_position + v2{0, 0.4};
            hit_player, found := Scene.get_closest_component_in_range(pos, 0.8, Player);
            if found && hit_player != null {
                if hit_player.entity.id != owner_id && hit_player.entity.id != last_hit_id {
                    hit_player.health -= damage;
                    if hit_player.health < 0 {
                        hit_player.health = 0;
                    }

                    hit_sfx := get_asset(SFX_Asset, "sounds/reusable-weapons/buzzshot_projectile_ricochet.wav");
                    sfx_desc := SFX.default_sfx_desc();
                    sfx_desc->set_position(pos);
                    sfx_desc.range_multiplier = 2.0;
                    SFX.play(hit_sfx, sfx_desc);

                    bounce_count += 1;
                    last_hit_id = hit_player.entity.id;

                    // Scale damage on bounce
                    if damage_scale_per_bounce > 0 {
                        damage = damage * damage_scale_per_bounce;
                    }

                    // Grow on bounce (MegaBlade)
                    if grow_per_bounce {
                        scale := entity.local_scale;
                        entity->set_local_scale({scale.x * 1.1, scale.y * 1.1});
                    }

                    if bounce_count >= max_bounces {
                        entity->destroy();
                        return;
                    }

                    // Find next target
                    next_target := find_bounce_target(pos, owner_id, last_hit_id, bounce_target_radius);
                    if next_target != null {
                        to_target := v2{next_target.entity.world_position.x - pos.x, next_target.entity.world_position.y - pos.y};
                        direction = normalize(to_target);
                        angle := atan2(direction.y, direction.x);
                        entity->set_local_rotation(to_degrees(angle));
                    }
                }
            }
        }
    }
}

find_bounce_target :: proc(pos: v2, owner_id: u64, last_hit_id: u64, radius: float) -> Player {
    nearby: [..]Player;
    Scene.get_all_components_in_range(pos, radius, ref nearby);

    closest: Player;
    closest_dist: float = 99999.0;

    for p: nearby {
        if p.entity.id == owner_id continue;
        if p.entity.id == last_hit_id continue;
        if p.health <= 0 continue;

        dx := p.entity.world_position.x - pos.x;
        dy := p.entity.world_position.y - pos.y;
        dist := dx * dx + dy * dy;
        if dist < closest_dist {
            closest_dist = dist;
            closest = p;
        }
    }

    return closest;
}

spawn_bouncing_projectile :: proc(player: Player, direction: v2, wt: Weapon_Type) {
    if !Game.is_server() return;

    config := get_weapon_config(wt);
    bone_local := player.animator.instance->get_bone_local_position("PROJECTILE");
    barrel_dist := length(bone_local);
    dir := normalize(direction);
    spawn_pos := v2{player.animator.entity.world_position.x + dir.x * barrel_dist, player.animator.entity.world_position.y + dir.y * barrel_dist};

    proj_entity := Scene.create_entity();
    proj_entity->set_local_position(spawn_pos);

    angle := atan2(direction.y, direction.x);
    proj_entity->set_local_rotation(to_degrees(angle));

    texture_path := "sprites/reusable-weapons/projectiles/buzzsaw.png";
    if wt == .MEGA_BLADE {
        texture_path = "sprites/reusable-weapons/projectiles/megablade.png";
    }
    proj_texture := get_asset(Texture_Asset, texture_path);
    sprite := proj_entity->add_component(Sprite_Renderer);
    sprite->set_texture(proj_texture);
    if wt == .MEGA_BLADE {
        proj_entity->set_local_scale({1.7, 1.7});
    } else {
        proj_entity->set_local_scale({2, 2});
    }

    proj := proj_entity->add_component(Bouncing_Projectile);
    proj.damage = config.base_damage;
    proj.direction = normalize(direction);
    proj.owner_id = player.entity.id;
    proj.speed = config.projectile_speed;
    proj.max_lifetime = 5.0;
    proj.max_bounces = config.max_bounces;
    proj.bounce_target_radius = config.bounce_target_radius;
    proj.damage_scale_per_bounce = 1.25;
    if wt == .MEGA_BLADE {
        proj.grow_per_bounce = true;
    }
}
