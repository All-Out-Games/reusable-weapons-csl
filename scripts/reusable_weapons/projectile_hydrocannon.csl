GEYSER_LIFETIME :: 1.167;
GEYSER_DAMAGE :: 50.0;
GEYSER_SPAWN_INTERVAL :: 0.2;
MAX_GEYSER_SPAWNS :: 10;
GEYSER_HIT_RADIUS :: 2.0;

Hydro_Cannon_Projectile :: class : Component {
    direction: v2;
    owner_id: u64;
    speed: float;
    lifetime: float;
    max_lifetime: float;
    geyser_timer: float;
    geysers_spawned: s64;

    ao_start :: method() {
        // Start with timer at the interval so first geyser spawns immediately
        geyser_timer = GEYSER_SPAWN_INTERVAL;
    }

    ao_update :: method(dt: float) {
        lifetime += dt;
        if max_lifetime <= 0 {
            max_lifetime = 3.0;
        }
        if lifetime > max_lifetime {
            entity->destroy();
            return;
        }

        // Move projectile
        move := v2{direction.x * speed * dt, direction.y * speed * dt};
        entity->add_local_position(move);

        // Spawn geysers along path (server only)
        if Game.is_server() {
            if geysers_spawned < MAX_GEYSER_SPAWNS {
                geyser_timer += dt;
                if geyser_timer >= GEYSER_SPAWN_INTERVAL {
                    geyser_timer = 0.0;
                    geysers_spawned += 1;

                    geyser_prefab := get_asset(Prefab_Asset, "Weapon_HydroCannonGeyser.prefab");
                    geyser_entity := Scene.instantiate(geyser_prefab);
                    geyser_entity->set_local_position(entity.world_position);

                    geyser := geyser_entity->add_component(Hydro_Cannon_Geyser);
                    geyser.owner_id = owner_id;

                    // Set up splash animation
                    spine := geyser_entity->get_component(Spine_Animator);
                    if spine != null {
                        spine->awaken();
                        spine.instance->set_animation("013RED/Splash", false, 0);
                    }

                    // Play random splash sound
                    rng: u64 = rng_seed_time();
                    splash_index := rng_range_int(ref rng, 1, 3);
                    splash_path := "sounds/reusable-weapons/geyser_splash_01.wav";
                    if splash_index == 2 { splash_path = "sounds/reusable-weapons/geyser_splash_02.wav"; }
                    if splash_index == 3 { splash_path = "sounds/reusable-weapons/geyser_splash_03.wav"; }
                    sfx_desc := SFX.default_sfx_desc();
                    sfx_desc->set_position(entity.world_position);
                    sfx_desc.range_multiplier = 2.0;
                    SFX.play(get_asset(SFX_Asset, splash_path), sfx_desc);
                }
            }
        }
    }
}

Hydro_Cannon_Geyser :: class : Component {
    owner_id: u64;
    lifetime: float;
    hit_ids: [32]u64;
    hit_count: s64;

    ao_update :: method(dt: float) {
        if !Game.is_server() return;

        lifetime += dt;
        if lifetime >= GEYSER_LIFETIME {
            entity->destroy();
            return;
        }

        // Damage nearby players
        pos := entity.world_position;
        nearby: [..]Player;
        Scene.get_all_components_in_range(pos, GEYSER_HIT_RADIUS, ref nearby);

        for target: nearby {
            if target.entity.id == owner_id continue;
            if target.health <= 0 continue;

            // Check if already hit by this geyser
            already_hit := false;
            j := 0;
            while j < hit_count {
                if hit_ids[j] == target.entity.id {
                    already_hit = true;
                }
                j += 1;
            }
            if already_hit continue;

            // Record hit and apply damage
            if hit_count < 32 {
                hit_ids[hit_count] = target.entity.id;
                hit_count += 1;
            }

            target.health -= GEYSER_DAMAGE;
            if target.health < 0 {
                target.health = 0;
            }
        }
    }
}

spawn_hydrocannon_projectile :: proc(player: Player, direction: v2, wt: Weapon_Type) {
    if !Game.is_server() return;

    config := get_weapon_config(wt);

    bone_local := player.animator.instance->get_bone_local_position("PROJECTILE");
    barrel_dist := length(bone_local);
    dir := normalize(direction);
    spawn_pos := v2{player.animator.entity.world_position.x + dir.x * barrel_dist, player.animator.entity.world_position.y + dir.y * barrel_dist};

    proj_entity := Scene.create_entity();
    proj_entity->set_local_position(spawn_pos);
    proj_entity->set_local_rotation(to_degrees(atan2(direction.y, direction.x)));
    proj_entity->set_local_scale({2, 2});

    setup_projectile_spine(proj_entity, "water_gun", TRAVEL_LOOP);

    proj := proj_entity->add_component(Hydro_Cannon_Projectile);
    proj.direction = dir;
    proj.owner_id = player.entity.id;
    proj.speed = config.projectile_speed;
    proj.max_lifetime = config.projectile_lifetime;
}
