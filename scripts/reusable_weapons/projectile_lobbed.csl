LOBBED_ARC_HEIGHT :: 2.0;

Lobbed_Projectile :: class : Component {
    damage: float;
    direction: v2;
    owner_id: u64;
    speed: float;
    travel_distance: float;
    max_distance: float;
    aoe_radius: float;
    aoe_damage: float;
    weapon_type: Weapon_Type;
    start_pos: v2;
    started: bool;

    ao_update :: method(dt: float) {
        if !started {
            started = true;
            start_pos = entity.world_position;
            if max_distance <= 0 {
                max_distance = 8.0;
            }
        }

        move_dist := speed * dt;
        travel_distance += move_dist;

        // Parabolic arc: height = -h * ((x/(0.5*r)) - 1)^2 + h
        t := travel_distance / max_distance;
        arc_height := -LOBBED_ARC_HEIGHT * (2.0 * t - 1.0) * (2.0 * t - 1.0) + LOBBED_ARC_HEIGHT;

        ground_pos := v2{start_pos.x + direction.x * travel_distance, start_pos.y + direction.y * travel_distance};
        entity->set_local_position({ground_pos.x, ground_pos.y + arc_height});

        // Scale entity to simulate height
        scale_factor := 1.0 + arc_height * 0.3;
        entity->set_local_scale({2.0 * scale_factor, 2.0 * scale_factor});

        // Landed
        if travel_distance >= max_distance {
            if Game.is_server() {
                land_pos := v2{start_pos.x + direction.x * max_distance, start_pos.y + direction.y * max_distance};
                on_lobbed_land(land_pos, owner_id, aoe_radius, aoe_damage, weapon_type);
            }
            entity->destroy();
            return;
        }
    }
}

on_lobbed_land :: proc(pos: v2, owner_id: u64, radius: float, damage: float, wt: Weapon_Type) {
    // AOE damage at landing position
    apply_aoe_damage(pos, owner_id, radius, damage);

    // Play explosion sound
    switch wt {
        case .GOLDEN_ROCKET_LAUNCHER: {
            sfx := get_asset(SFX_Asset, "reusable_weapons/sounds/reusable-weapons/rocket_launcher_explode.wav");
            desc := SFX.default_sfx_desc();
            desc->set_position(pos);
            desc.range_multiplier = 3.0;
            SFX.play(sfx, desc);
        }
        case .WATER_BALLOON_RPG: {
            // Random splash sound
            rng: u64 = rng_seed_time();
            splash_index := rng_range_int(ref rng, 1, 3);
            splash_path := "reusable_weapons/sounds/reusable-weapons/geyser_splash_01.wav";
            if splash_index == 2 { splash_path = "reusable_weapons/sounds/reusable-weapons/geyser_splash_02.wav"; }
            if splash_index == 3 { splash_path = "reusable_weapons/sounds/reusable-weapons/geyser_splash_03.wav"; }
            sfx := get_asset(SFX_Asset, splash_path);
            desc := SFX.default_sfx_desc();
            desc->set_position(pos);
            desc.range_multiplier = 3.0;
            SFX.play(sfx, desc);

            // Spawn water balloon splash VFX
            spawn_simple_vfx("reusable_weapons/VFX_WaterBalloonSplash.prefab", pos, {1, 1}, "013RED/Splash", 1.5);
        }
        case .POISON_GRENADE: {
            sfx := get_asset(SFX_Asset, "reusable_weapons/sounds/reusable-weapons/grenade_poison_explode.wav");
            desc := SFX.default_sfx_desc();
            desc->set_position(pos);
            desc.range_multiplier = 3.0;
            SFX.play(sfx, desc);
            // Spawn poison cloud entity
            spawn_poison_cloud(pos, owner_id);
        }
        case .BOOMWHEEL: {
            sfx := get_asset(SFX_Asset, "reusable_weapons/sounds/reusable-weapons/cannon_explode.wav");
            desc := SFX.default_sfx_desc();
            desc->set_position(pos);
            desc.range_multiplier = 3.0;
            SFX.play(sfx, desc);

            // Spawn nuke explosion VFX
            spawn_simple_vfx("reusable_weapons/VFX_BoomwheelNuke.prefab", pos, {1.5, 1.5}, "Nuke_explosion", 0.75);

            // Spawn crater VFX (intro -> idle loop -> despawn)
            spawn_looping_vfx("reusable_weapons/VFX_BoomwheelCrater.prefab", pos, {2, 2}, "MWSD116/spawn", "MWSD116/idle", "MWSD116/despawn", 15.0, 0.7);

            // Spawn 10 small bombs in a circle
            spawn_cluster_bombs(pos, owner_id);
        }
    }
}

spawn_lobbed_projectile :: proc(player: Player, direction: v2, wt: Weapon_Type) {
    if !Game.is_server() return;

    config := get_weapon_config(wt);
    bone_local := player.animator.instance->get_bone_local_position("PROJECTILE");
    barrel_dist := length(bone_local);
    dir := normalize(direction);
    spawn_pos := v2{player.animator.entity.world_position.x + dir.x * barrel_dist, player.animator.entity.world_position.y + dir.y * barrel_dist};

    proj_entity := Scene.create_entity();
    proj_entity->set_local_position(spawn_pos);

    // Choose texture based on weapon
    texture_path := "reusable_weapons/sprites/reusable-weapons/projectiles/grenade.png";
    switch wt {
        case .GOLDEN_ROCKET_LAUNCHER: { texture_path = "reusable_weapons/sprites/reusable-weapons/projectiles/golden_nuke.png"; }
        case .WATER_BALLOON_RPG: { texture_path = "reusable_weapons/sprites/reusable-weapons/projectiles/waterballoon.png"; }
        case .BOOMWHEEL: { texture_path = "reusable_weapons/sprites/reusable-weapons/projectiles/cannonball.png"; }
    }

    proj_texture := get_asset(Texture_Asset, texture_path);
    sprite := proj_entity->add_component(Sprite_Renderer);
    sprite->set_texture(proj_texture);
    proj_entity->set_local_scale({2, 2});

    proj := proj_entity->add_component(Lobbed_Projectile);
    proj.damage = config.base_damage;
    proj.direction = normalize(direction);
    proj.owner_id = player.entity.id;
    proj.speed = config.projectile_speed;
    proj.max_distance = 8.0;
    proj.aoe_radius = config.aoe_radius;
    proj.aoe_damage = config.aoe_damage;
    proj.weapon_type = wt;
}
