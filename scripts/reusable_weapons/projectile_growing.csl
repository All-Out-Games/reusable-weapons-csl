Growing_Projectile :: class : Component {
    damage: float;
    lifetime: float;
    direction: v2;
    owner_id: u64;
    speed: float;
    max_lifetime: float;
    hit_count: s64;
    max_hits: s64;
    hit_ids: [32]u64;
    hit_id_count: s64;

    ao_update :: method(dt: float) {
        lifetime += dt;
        if max_lifetime <= 0 {
            max_lifetime = 5.0;
        }
        if lifetime > max_lifetime {
            entity->destroy();
            return;
        }

        move := v2{direction.x * speed * dt, direction.y * speed * dt};
        entity->add_local_position(move);

        if Game.is_server() {
            // Scale hit radius with entity scale
            scale := entity.local_scale.x / 2.0;
            radius := 0.8 * scale;
            if radius < 0.8 {
                radius = 0.8;
            }

            pos := entity.world_position + v2{0, -0.5};
            nearby: [..]Player;
            Scene.get_all_components_in_range(pos, radius, ref nearby);

            for hit_player: nearby {
                if hit_player.entity.id == owner_id continue;

                // Check if already hit
                already_hit := false;
                j := 0;
                while j < hit_id_count {
                    if hit_ids[j] == hit_player.entity.id {
                        already_hit = true;
                    }
                    j += 1;
                }
                if already_hit continue;

                // Record hit
                if hit_id_count < 32 {
                    hit_ids[hit_id_count] = hit_player.entity.id;
                    hit_id_count += 1;
                }

                hit_player.health -= damage;
                if hit_player.health < 0 {
                    hit_player.health = 0;
                }

                // Grow on hit
                hit_count += 1;
                damage = damage * 1.25;
                cur_scale := entity.local_scale;
                entity->set_local_scale({cur_scale.x * 1.5, cur_scale.y * 1.5});

                sfx := get_asset(SFX_Asset, "reusable_weapons/sounds/reusable-weapons/plasma_burst_hit.wav");
                sfx_desc := SFX.default_sfx_desc();
                sfx_desc->set_position(pos);
                sfx_desc.range_multiplier = 2.0;
                SFX.play(sfx, sfx_desc);
            }
        }
    }
}

spawn_growing_projectile :: proc(player: Player, direction: v2, wt: Weapon_Type) {
    if !Game.is_server() return;

    config := get_weapon_config(wt);
    bone_local := player.animator.instance->get_bone_local_position("PROJECTILE");
    barrel_dist := length(bone_local);
    dir := normalize(direction);
    spawn_pos := v2{player.animator.entity.world_position.x + dir.x * barrel_dist, player.animator.entity.world_position.y + dir.y * barrel_dist};

    proj_entity := Scene.create_entity();
    proj_entity->set_local_position(spawn_pos);

    angle := atan2(direction.y, direction.x);
    proj_entity->set_local_rotation(to_degrees(angle));

    // Use the laser bolt texture for plasma
    proj_texture := get_asset(Texture_Asset, "reusable_weapons/sprites/reusable-weapons/projectiles/MachineGunBullet.png");
    sprite := proj_entity->add_component(Sprite_Renderer);
    sprite->set_texture(proj_texture);
    sprite.color = {0.8, 0.2, 1.0, 1.0};
    proj_entity->set_local_scale({2.8, 2.8});

    proj := proj_entity->add_component(Growing_Projectile);
    proj.damage = config.base_damage;
    proj.direction = normalize(direction);
    proj.owner_id = player.entity.id;
    proj.speed = config.projectile_speed;
    proj.max_lifetime = 5.0;
    proj.max_hits = 10;
}
